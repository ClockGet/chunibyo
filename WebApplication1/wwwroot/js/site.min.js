(function(){"use strict";var module,app;Storage.prototype.setObject=function(key,value){this.setItem(key,JSON.stringify(value))};Storage.prototype.getObject=function(key){var value=this.getItem(key);return value&&JSON.parse(value)};module=angular.module("visibilityChange",[]);module.service("VisibilityChange",["$document","$rootScope","$timeout",function($document,$rootScope,$timeout){var broadcastVisibleEvent="pageBecameVisible",broadcastHiddenEvent="pageBecameHidden",broadcastEnabled=!1,hidden="hidden",changeCallbacks=[],visibleCallbacks=[],hiddenCallbacks=[],$doc=$document[0],visibilityChange;if(this.configure=function(config){if(typeof config!="object")throw new Error(config+" is not a valid configuration object");config.broadcast===!0?broadcastEnabled=!0:typeof config.broadcast=="object"&&(broadcastEnabled=!0,broadcastVisibleEvent=config.broadcast.visible||broadcastVisibleEvent,broadcastHiddenEvent=config.broadcast.hidden||broadcastHiddenEvent)},this.onChange=function(callback){changeCallbacks.push(callback)},this.onVisible=function(callback){visibleCallbacks.push(callback)},this.onHidden=function(callback){hiddenCallbacks.push(callback)},hidden in $doc)visibilityChange="visibilitychange";else if((hidden="webkitHidden")in $doc)visibilityChange="webkitvisibilitychange";else if((hidden="mozHidden")in $doc)visibilityChange="mozvisibilitychange";else if((hidden="msHidden")in $doc)visibilityChange="msvisibilitychange";else return;var onVisibilityChange=function(){$timeout(function(){$document[0][hidden]?notifyHidden():notifyVisible()},100)},execCallbacks=function(){for(var args=Array.prototype.slice.call(arguments),callbacks=args.shift(),i=0;i<callbacks.length;i++)callbacks[i].apply(null,args)},notifyHidden=function(){broadcastEnabled&&$rootScope.$broadcast(broadcastHiddenEvent);execCallbacks(changeCallbacks,!1);execCallbacks(hiddenCallbacks)},notifyVisible=function(){broadcastEnabled&&$rootScope.$broadcast(broadcastVisibleEvent);execCallbacks(changeCallbacks,!0);execCallbacks(visibleCallbacks)};$document.on(visibilityChange,onVisibilityChange)}]);app=angular.module("chunibyo",["angularSoundManager","ui-notification","angularLazyImg","authentication.service","ngScrollbars","visibilityChange"]);app.config(["$httpProvider",function($httpProvider){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded";$httpProvider.interceptors.push(["$q","$rootScope","$injector",function($q,$rootScope,$injector){return{request:function(config){return $rootScope.loading=!0,$q.resolve(config)},response:function(response){return $rootScope.loading=!1,$q.resolve(response)},requestError:function(rejection){return $rootScope.loading=!1,$q.reject(rejection)},responseError:function(rejection){return $rootScope.loading=!1,rejection.status===401&&($rootScope.user.isLogin=!1,$injector.get("Notification").warning("同步歌单请先登录")),$q.reject(rejection)}}}])}]);app.config(function(NotificationProvider){NotificationProvider.setOptions({delay:2e3,startTop:20,startRight:10,verticalSpacing:20,horizontalSpacing:20,positionX:"center",positionY:"top"})});app.config(function(lazyImgConfigProvider){var scrollable=document.querySelector("#hot-play-list");lazyImgConfigProvider.setOptions({offset:0,container:angular.element(scrollable)})});app.config(function(ScrollBarsProvider){ScrollBarsProvider.defaults={scrollButtons:{scrollAmount:"auto",enable:!0}}});app.filter("playmode_title",function(){return function(input){switch(input){case 0:return"顺序";case 1:return"随机";case 2:return"单曲循环"}}});app.controller("NavigationController",["$scope","$http","$httpParamSerializerJQLike","$timeout","angularPlayer","Notification","$rootScope","AuthenticationService","VisibilityChange",function($scope,$http,$httpParamSerializerJQLike,$timeout,angularPlayer,Notification,$rootScope,AuthenticationService,VisibilityChange){$scope.window_url_stack=[];$scope.current_tag=1;$scope.is_window_hidden=1;$scope.is_dialog_hidden=1;$scope.songs=[];$scope.current_list_id=-1;$scope.dialog_song="";$scope.dialog_type=0;$scope.dialog_title="";$rootScope.page_title="Chunibyo";$scope.config={autoHideScrollbar:!1,theme:"light",advanced:{updateOnContentResize:!0},scrollInertia:0};$scope.showTag=function(tag_id){$scope.current_tag=tag_id;$scope.is_window_hidden=1;$scope.window_url_stack=[];$scope.closeWindow()};$scope.resetWindow=function(){$scope.cover_img_url="/images/loading.gif";$scope.playlist_title="";$scope.songs=[]};$scope.showWindow=function(url){$scope.is_window_hidden=0;$scope.resetWindow();$scope.window_url_stack.push(url);$http.get(url).then(function(datas){var data=datas.data;if(data.status=="0"){Notification.info(data.reason);$scope.popWindow();return}$scope.songs=data.tracks;$scope.cover_img_url=data.info.coverImgUrl;$scope.playlist_title=data.info.title;$scope.list_id=data.info.id;$scope.is_mine=data.is_mine})};$scope.closeWindow=function(){$scope.is_window_hidden=1;$scope.resetWindow();$scope.window_url_stack=[]};$scope.popWindow=function(){if($scope.window_url_stack.pop(),$scope.window_url_stack.length===0)$scope.closeWindow();else{$scope.resetWindow();var url=$scope.window_url_stack[$scope.window_url_stack.length-1];$http.get(url).then(function(datas){var data=datas.data;$scope.songs=data.tracks;$scope.cover_img_url=data.info.cover_img_url;$scope.playlist_title=data.info.title})}};$scope.showPlaylist=function(list_id,my){if(list_id){var url="";url=my?"api/myplaylist/list?listId="+list_id:"api/playlist/list?listId="+list_id;$scope.showWindow(url)}};$scope.showArtist=function(artist_id){if(artist_id){var url="api/playlist/artist?artistId="+artist_id;$scope.showWindow(url)}};$scope.showAlbum=function(album_id){if(album_id){var url="api/playlist/album?albumId="+album_id;$scope.showWindow(url)}};$scope.directplaylist=function(list_id){if(list_id){var url="/api/myplaylist/list?listId="+list_id;$http.get(url).then(function(datas){var data=datas.data;$scope.songs=data.tracks;$scope.current_list_id=list_id;$timeout(function(){angularPlayer.clearPlaylist(function(){var index,max,min;angularPlayer.addTrackArray($scope.songs);index=0;angularPlayer.getShuffle()&&(max=$scope.songs.length-1,min=0,index=Math.floor(Math.random()*(max-min+1))+min);angularPlayer.playTrack($scope.songs[index].id)})},0)})}};$scope.showDialog=function(dialog_type,data){var dialogWidth,left,url;if(!data){Notification.warning("当前无歌曲");return}$scope.is_dialog_hidden=0;dialogWidth=480;left=$(window).width()/2-dialogWidth/2;$scope.myStyle={left:left+"px"};dialog_type==0&&($scope.dialog_title="添加到歌单",url="/api/myplaylist/show",$scope.dialog_song=data,$http.get(url).then(function(datas){var data=datas.data;$scope.myplaylist=data.result}))};$scope.chooseDialogOption=function(option_id){$http({url:"/api/myplaylist/add",method:"POST",data:$httpParamSerializerJQLike({listId:option_id,id:$scope.dialog_song.id,title:$scope.dialog_song.title,artist:$scope.dialog_song.artist,url:$scope.dialog_song.url,artistId:$scope.dialog_song.artistId,album:$scope.dialog_song.album,albumId:$scope.dialog_song.albumId,source:$scope.dialog_song.source,sourceUrl:$scope.dialog_song.sourceUrl,imgUrl:$scope.dialog_song.imgUrl,lyricUrl:$scope.dialog_song.lyricUrl}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(result){result.data.success?(Notification.success("添加到歌单成功"),$scope.closeDialog(),option_id==$scope.current_list_id&&angularPlayer.addTrack($scope.dialog_song)):Notification.error(result.data.message)})};$scope.newDialogOption=function(){$scope.dialog_type=1};$scope.cancelNewDialog=function(){$scope.dialog_type=0};$scope.createAndAddPlaylist=function(){$scope.dialog_song&&$http({url:"/api/myplaylist/create",method:"POST",data:$httpParamSerializerJQLike({listTitle:$scope.newlist_title,id:$scope.dialog_song.id,title:$scope.dialog_song.title,artist:$scope.dialog_song.artist,url:$scope.dialog_song.url,artistId:$scope.dialog_song.artistId,album:$scope.dialog_song.album,albumId:$scope.dialog_song.albumId,source:$scope.dialog_song.source,sourceUrl:$scope.dialog_song.sourceUrl,imgUrl:$scope.dialog_song.imgUrl,lyricUrl:$scope.dialog_song.lyricUrl}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(result){result.data.success?($rootScope.$broadcast("myplaylist:update"),Notification.success("添加到歌单成功"),$scope.closeDialog()):Notification.error(result.data.message)})};$scope.removeSongFromPlaylist=function(song,list_id){$http({url:"/api/myplaylist/removetrack",method:"POST",data:$httpParamSerializerJQLike({listId:list_id,trackId:song.id}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(result){if(result.data.success){var index=$scope.songs.indexOf(song);index>-1&&$scope.songs.splice(index,1);Notification.success("删除成功")}else Notification.error(result.data.message)})};$scope.closeDialog=function(){$scope.is_dialog_hidden=1;$scope.dialog_type=0};$scope.setCurrentList=function(list_id){$scope.current_list_id=list_id};$scope.playmylist=function(list_id){$timeout(function(){angularPlayer.clearPlaylist(function(){var index,max,min;angularPlayer.addTrackArray($scope.songs);index=0;angularPlayer.getShuffle()&&(max=$scope.songs.length-1,min=0,index=Math.floor(Math.random()*(max-min+1))+min);angularPlayer.playTrack($scope.songs[index].id)})},0);$scope.setCurrentList(list_id)};$scope.removemylist=function(list_id){$http({url:"/api/myplaylist/remove",method:"POST",data:$httpParamSerializerJQLike({listId:list_id}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(result){result.data.success?($rootScope.$broadcast("myplaylist:update"),$scope.closeWindow(),Notification.success("删除成功")):Notification.error(result.data.message)})};$scope.clonelist=function(list_id){$http({url:"/api/myplaylist/clone",method:"POST",data:$httpParamSerializerJQLike({listId:list_id}),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(result){result.data.success?($rootScope.$broadcast("myplaylist:update"),$scope.closeWindow(),Notification.success("收藏到我的歌单成功")):Notification.error(result.data.message)})};$rootScope.user={isLogin:!0};var timer;VisibilityChange.onChange(function(visible){visible?($rootScope.page_title="(*´∇｀*)  被你发现啦~ "+$rootScope.origin_title,timer=$timeout(function(){$rootScope.page_title=$rootScope.origin_title},4e3)):($rootScope.origin_title=$rootScope.page_title,$rootScope.page_title="(つェ⊂)我藏好了哦",$timeout.cancel(timer))})}]);app.controller("PlayController",["$scope","$timeout","$log","$anchorScroll","$location","angularPlayer","$http","$httpParamSerializerJQLike","$rootScope","Notification",function($scope,$timeout,$log,$anchorScroll,$location,angularPlayer,$http,$httpParamSerializerJQLike,$rootScope){function switchMode(mode){switch(mode){case 0:angularPlayer.getShuffle()&&angularPlayer.toggleShuffle();angularPlayer.setRepeatOneStatus(!1);break;case 1:angularPlayer.getShuffle()||angularPlayer.toggleShuffle();angularPlayer.setRepeatOneStatus(!1);break;case 2:angularPlayer.getShuffle()&&angularPlayer.toggleShuffle();angularPlayer.setRepeatOneStatus(!0)}}function parseLyric(lyric){function rightPadding(str,length,padChar){for(var newstr=str,i=0;i<length-str.length;i++)newstr+=padChar;return newstr}for(var timeReg,seconds,lyricObject,line,lines=lyric.split("\n"),result=[],timeResult=[],timeRegResult=null,i=0;i<lines.length;i++){var line=lines[i],tagRegResult=/\[\D*:([^\]]+)\]/g.exec(line);if(tagRegResult){lyricObject={};lyricObject.seconds=0;lyricObject.content=tagRegResult[1];result.push(lyricObject);continue}for(timeReg=/\[(\d{2,})\:(\d{2})(?:\.(\d{1,3}))?\]/g;timeRegResult=timeReg.exec(line);){var content=line.replace(/\[(\d{2,})\:(\d{2})(?:\.(\d{1,3}))?\]/g,""),min=parseInt(timeRegResult[1]),sec=parseInt(timeRegResult[2]),microsec=0;timeRegResult[3]!=null&&(microsec=parseInt(rightPadding(timeRegResult[3],3,"0")));seconds=min*6e4+sec*1e3+microsec;lyricObject={};lyricObject.content=content;lyricObject.seconds=seconds;timeResult.push(lyricObject)}}for(timeResult.sort(function(a,b){var keyA=a.seconds,keyB=b.seconds;return keyA<keyB?-1:keyA>keyB?1:0}),result=timeResult,i=0;i<result.length;i++)result[i].lineNumber=i;if(result.length===0&&lines.length>0){for(i=0;i<lines.length;i++)line=lines[i],lyricObject={},lyricObject.seconds=-1,lyricObject.content=line,lyricObject.lineNumber=i,result.push(lyricObject);lyricObject={};lyricObject.seconds=-1;lyricObject.content="(歌词暂不支持滚动)";lyricObject.lineNumber=i;result.push(lyricObject)}return result}var _canvasBufferContext,lastData;$scope.menuHidden=!0;$scope.volume=angularPlayer.getVolume();$scope.mute=angularPlayer.getMuteStatus();$scope.settings={playmode:0,nowplaying_track_id:-1};$scope.lyricArray=[];$scope.lyricLineNumber=-1;$scope.lastTrackId=null;$scope.show_lyric=!0;$scope.loadLocalSettings=function(){var localSettings=localStorage.getObject("player-settings");localSettings==null?($scope.settings={playmode:0,nowplaying_track_id:-1},$scope.saveLocalSettings()):$scope.settings=localSettings;switchMode($scope.settings.playmode)};$scope.saveLocalSettings=function(){localStorage.setObject("player-settings",$scope.settings)};$scope.loadLocalCurrentPlaying=function(){var localSettings=localStorage.getObject("current-playing");localSettings!=null&&angularPlayer.addTrackArray(localSettings)};$scope.saveLocalCurrentPlaying=function(){localStorage.setObjct("current-playing",angularPlayer.playlist)};$scope.changePlaymode=function(){$scope.settings.playmode=($scope.settings.playmode+1)%3;switchMode($scope.settings.playmode);$scope.saveLocalSettings()};$scope.$on("music:volume",function(event,data){$scope.$apply(function(){$scope.volume=data})});$scope.$on("angularPlayer:ready",function(){var localCurrentPlaying,localPlayerSettings,track_id;($log.debug("cleared, ok now add to playlist"),angularPlayer.getRepeatStatus()==!1&&angularPlayer.repeatToggle(),localCurrentPlaying=localStorage.getObject("current-playing"),localCurrentPlaying!=null)&&(angularPlayer.addTrackArray(localCurrentPlaying),localPlayerSettings=localStorage.getObject("player-settings"),localPlayerSettings!=null)&&(track_id=localPlayerSettings.nowplaying_track_id,track_id!=-1?angularPlayer.playTrack(track_id):angularPlayer.play(),angularPlayer.pause(),angularPlayer.setAnimationFPS(20),angularPlayer.tick())});$scope.gotoAnchor=function(newHash){$location.hash()!==newHash?($location.hash(newHash),$anchorScroll()):$anchorScroll()};$scope.togglePlaylist=function(){var anchor="song"+angularPlayer.getCurrentTrack();$scope.menuHidden=!$scope.menuHidden;$scope.menuHidden||$scope.gotoAnchor(anchor)};$scope.toggleMuteStatus=function(){angularPlayer.mute()};$scope.myProgress=0;$scope.changingProgress=!1;$rootScope.$on("track:progress",function(event,data){$scope.changingProgress==!1&&($scope.myProgress=data)});$rootScope.$on("track:myprogress",function(event,data){$scope.$apply(function(){$scope.myProgress=data})});$scope.tempVolume=0;$scope.$on("music:mute",function(event,data){$scope.mute=data;data?($scope.tempVolume=$scope.volume,$timeout(function(){angularPlayer.adjustVolumeSlider(0)},0)):$timeout(function(){angularPlayer.adjustVolumeSlider($scope.volume>0?$scope.volume:$scope.tempVolume)},0)});$scope.$on("track:id",function(event,data){var current,url,track,styleTag;if($scope.lastTrackId!=data){if(data==null){$scope.lastTrackId=null;current=localStorage.getObject("player-settings");current.nowplaying_track_id=-1;localStorage.setObject("player-settings",current);$rootScope.page_title="■ ";return}current=localStorage.getObject("player-settings");current.nowplaying_track_id=data;localStorage.setObject("player-settings",current);$scope.lyricArray=[];$scope.lyricLineNumber=-1;$timeout(function(){$scope.updateScrollbar("scrollTo",0,{scrollInertia:500})});url="/api/playlist/lyric?trackId="+data;track=angularPlayer.getTrack(data);$rootScope.page_title="▶ "+track.title?track.title:" - "+track.artist?track.artist:"";track.lyricUrl!=null&&(url=url+"&lyricUrl="+encodeURIComponent(track.lyricUrl));$scope.lastTrackId&&$(".menu").removeClass($scope.lastTrackId);$(".menu").removeClass("default");track.imgUrl?($("#style_"+data).length==0&&(styleTag=$('<style id="style_'+data+'">.m-playbar .menu.'+data+"::before{background-image:url("+track.imgUrl+");}<\/style>"),$("html > head").append(styleTag)),$(".menu").addClass(data)):$(".menu").addClass("default");$http.get(url).then(function(datas){var data=datas.data,lyric=data.lyric;lyric!=null&&($scope.lyricArray=parseLyric(lyric))});$scope.lastTrackId=data}});$scope.$on("currentTrack:position",function(event,data){var currentSeconds,lastObject,i,lyricObject;if($scope.show_lyric){for(currentSeconds=data,lastObject=null,i=0;i<$scope.lyricArray.length;i++){if(lyricObject=$scope.lyricArray[i],lyricObject.seconds===-1||currentSeconds<lyricObject.seconds)break;lastObject=lyricObject}if(lastObject&&lastObject.lineNumber!=$scope.lyricLineNumber){var lineElement=$(".lyric p")[lastObject.lineNumber],offset=lineElement.offsetTop-135;$timeout(function(){$scope.updateScrollbar("scrollTo",offset,{scrollInertia:500})});$scope.lyricLineNumber=lastObject.lineNumber}}});$scope.last=null;$scope.fps=0;$scope.offset=0;angularPlayer.setShowFrequency(!0);var canvas=document.querySelector("#darwCanvas"),canvasCtx=canvas.getContext("2d"),_canvasBuffer=document.createElement("canvas");_canvasBuffer.width=canvas.width;_canvasBuffer.height=canvas.height;_canvasBufferContext=_canvasBuffer.getContext("2d");lastData=[];$scope.$on("currentTrack:Frequency",function(event,data){var i,z;if(!$scope.show_lyric){var width=_canvasBuffer.width,height=_canvasBuffer.height,center=height/2;canvasCtx.clearRect(0,0,width,height);_canvasBufferContext.clearRect(0,0,width,height);var barWidth=data===null||data.length===0?0:width/data.length*2.5,barHeight,x=0,color=_canvasBufferContext.createLinearGradient(0,center,0,height);for(color.addColorStop(0,"#222222"),color.addColorStop(1,"rgba(0,0,0,0)"),i=0;i<data.length;i++)z=data[i],lastData.length>=i&&z<lastData[i]&&(z=Math.max(lastData[i]-1,0)),barHeight=data[i]/255*center,_canvasBufferContext.fillStyle="rgb(34,34,34)",_canvasBufferContext.fillRect(x,center-z/255*center-2,barWidth,2),_canvasBufferContext.fillStyle="rgb("+Math.min(255,Math.round(data[i]/2+100))+",50,50)",_canvasBufferContext.fillRect(x,center-barHeight,barWidth,barHeight),_canvasBufferContext.fillStyle=color,_canvasBufferContext.fillRect(x,center,barWidth,barHeight),x+=barWidth+1;canvasCtx.drawImage(_canvasBuffer,0,0);lastData=data}});$scope.$on("player:playlist",function(event,data){localStorage.setObject("current-playing",data);data.length==0&&($(".menu").attr("class","menu default"),$scope.show_lyric?($scope.lyricArray=[],$scope.lyricLineNumber=-1):canvasCtx.clearRect(0,0,canvas.width,canvas.height))})}]);app.controller("InstantSearchController",["$scope","$http","$timeout","angularPlayer",function($scope,$http){$scope.tab=0;$scope.keywords="";$scope.loading=!1;$scope.changeTab=function(newTab){$scope.loading=!0;$scope.tab=newTab;$scope.result=[];$http.get("api/playlist/search?source="+$scope.tab+"&keywords="+$scope.keywords).then(function(datas){var data=datas.data;$scope.result=data.result;$scope.loading=!1})};$scope.isActiveTab=function(tab){return $scope.tab===tab};$scope.$watch("keywords",function(tmpStr){if(!tmpStr||tmpStr.length===0)return $scope.result=[],0;tmpStr===$scope.keywords&&($scope.loading=!0,$http.get("api/playlist/search?source="+$scope.tab+"&keywords="+$scope.keywords).then(function(datas){var data=datas.data;$scope.result=data.result;$scope.loading=!1}))})}]);app.directive("errSrc",function(){return{link:function(scope,element,attrs){element.bind("error",function(){attrs.src!=attrs.errSrc&&attrs.$set("src",attrs.errSrc)});attrs.$observe("ngSrc",function(value){!value&&attrs.errSrc&&attrs.$set("src",attrs.errSrc)})}}});app.directive("resize",function($window){return function(scope,element){var w=angular.element($window),changeHeight=function(){element.css("height",w.height()-180+"px")};w.bind("resize",function(){changeHeight()});changeHeight()}});app.directive("addAndPlay",["angularPlayer",function(angularPlayer){return{restrict:"EA",scope:{song:"=addAndPlay"},link:function(scope,element){element.bind("click",function(){angularPlayer.addTrack(scope.song);angularPlayer.playTrack(scope.song.id)})}}}]);app.directive("addWithoutPlay",["angularPlayer","Notification",function(angularPlayer,Notification){return{restrict:"EA",scope:{song:"=addWithoutPlay"},link:function(scope,element){element.bind("click",function(){angularPlayer.addTrack(scope.song);Notification.success("已添加到当前播放歌单")})}}}]);app.directive("openSongSource",["angularPlayer","$window",function(angularPlayer,$window){return{restrict:"EA",scope:{song:"=openSongSource"},link:function(scope,element){element.bind("click",function(){$window.open(scope.song.source_url,"_blank")})}}}]);app.directive("infiniteScroll",["$window",function(){return{restrict:"EA",scope:{infiniteScroll:"&",contentSelector:"=contentSelector"},link:function(scope,elements){elements.bind("scroll",function(){if(!scope.loading){var containerElement=elements[0],contentElement=document.querySelector(scope.contentSelector),baseTop=containerElement.getBoundingClientRect().top,currentTop=contentElement.getBoundingClientRect().top,baseHeight=containerElement.offsetHeight,offset=baseTop-currentTop,bottom=offset+baseHeight,height=contentElement.offsetHeight,remain=height-bottom;remain<=10&&scope.$apply(scope.infiniteScroll)}})}}}]);app.directive("draggable",["angularPlayer","$document","$rootScope",function(angularPlayer,$document,$rootScope){return function(scope,element,attrs){function onMyMousedown(){mode=="play"&&(scope.changingProgress=!0)}function onMyMouseup(){mode=="play"&&(scope.changingProgress=!1)}function onMyUpdateProgress(progress){mode=="play"&&$rootScope.$broadcast("track:myprogress",progress*100);mode=="volume"&&(angularPlayer.adjustVolumeSlider(progress*100),angularPlayer.getMuteStatus()==!0&&angularPlayer.mute())}function onMyCommitProgress(progress){var sound,duration,current;if(mode=="play"){if(angularPlayer.getCurrentTrack()===null)return;sound=soundManager.getSoundById(angularPlayer.getCurrentTrack());duration=sound.durationEstimate;sound.setPosition(progress*duration)}mode=="volume"&&(current=localStorage.getObject("player-settings"),current.volume=progress*100,localStorage.setObject("player-settings",current))}function mousemove(event){x=event.clientX-container.left;updateProgress()}function mouseup(){var progress=x/(container.right-container.left);commitProgress(progress);$document.off("mousemove",mousemove);$document.off("mouseup",mouseup);onMyMouseup()}function commitProgress(progress){onMyCommitProgress(progress)}function updateProgress(){container&&(x<0?x=0:x>container.right-container.left&&(x=container.right-container.left));var progress=x/(container.right-container.left);onMyUpdateProgress(progress)}var x,container,mode=attrs.mode;element.on("mousedown",function(event){onMyMousedown();container=document.getElementById(attrs.id).getBoundingClientRect();event.preventDefault();x=event.clientX-container.left;updateProgress();$document.on("mousemove",mousemove);$document.on("mouseup",mouseup)})}}]);app.directive("toggleSwitch",["$compile",function($compile){return{restrict:"EA",replace:!0,require:"ngModel",scope:{isDisabled:"=",onLabel:"@",offLabel:"@",knobLabel:"@",html:"=",onChange:"&"},template:'<div class="ats-switch" ng-click="toggle()" ng-keypress="onKeyPress($event)" ng-class="{ \'disabled\': isDisabled }" role="switch" aria-checked="{{!!model}}"><div class="switch-animate" ng-class="{\'switch-off\': !model, \'switch-on\': model}"><span class="switch-left"><\/span><span class="knob"><\/span><span class="switch-right"><\/span><\/div><\/div>',compile:function(element,attrs){return angular.isUndefined(attrs.onLabel)&&(attrs.onLabel="On"),angular.isUndefined(attrs.offLabel)&&(attrs.offLabel="Off"),angular.isUndefined(attrs.knobLabel)&&(attrs.knobLabel=" "),angular.isUndefined(attrs.isDisabled)&&(attrs.isDisabled=!1),angular.isUndefined(attrs.html)&&(attrs.html=!1),angular.isUndefined(attrs.tabindex)&&(attrs.tabindex=0),function(scope,iElement,iAttrs,ngModel){var spaceCharCode,bindSpan,bindSwitch;iElement.attr("tabindex",attrs.tabindex);scope.toggle=function(){scope.isDisabled||(scope.model=!scope.model,ngModel.$setViewValue(scope.model));scope.onChange()};spaceCharCode=32;scope.onKeyPress=function($event){$event.charCode!=spaceCharCode||$event.altKey||$event.ctrlKey||$event.metaKey||scope.toggle()};ngModel.$formatters.push(function(modelValue){return modelValue});ngModel.$parsers.push(function(viewValue){return viewValue});ngModel.$viewChangeListeners.push(function(){scope.$eval(attrs.ngChange)});ngModel.$render=function(){scope.model=ngModel.$viewValue};bindSpan=function(span,html){span=angular.element(span);var bindAttributeName=html===!0?"ng-bind-html":"ng-bind";span.removeAttr("ng-bind-html");span.removeAttr("ng-bind");angular.element(span).hasClass("switch-left")&&span.attr(bindAttributeName,"onLabel");span.hasClass("knob")&&span.attr(bindAttributeName,"knobLabel");span.hasClass("switch-right")&&span.attr(bindAttributeName,"offLabel");$compile(span)(scope,function(cloned){span.replaceWith(cloned)})};bindSwitch=function(iElement,html){angular.forEach(iElement[0].children[0].children,function(span){bindSpan(span,html)})};scope.$watch("html",function(newValue){bindSwitch(iElement,newValue)})}}}}]);app.controller("MyPlayListController",["$http","$scope","$timeout","angularPlayer",function($http,$scope){$scope.myplaylists=[];$scope.loadMyPlaylist=function(){$http.get("/api/myplaylist/show").then(function(datas){var data=datas.data;$scope.myplaylists=data.result})};$scope.$watch("current_tag",function(newValue,oldValue){newValue!==oldValue&&newValue=="1"&&($scope.myplaylists=[],$scope.loadMyPlaylist())});$scope.$on("myplaylist:update",function(){$scope.loadMyPlaylist()})}]);app.controller("PlayListController",["$http","$scope","$timeout","angularPlayer",function($http,$scope){$scope.result=[];$scope.tab=0;$scope.changeTab=function(newTab){$scope.tab=newTab;$scope.result=[];$http.get("/api/PlayList/Load?source="+$scope.tab).then(function(datas){var data=datas.data;$scope.result=data.result})};$scope.scrolling=function(){if($scope.loading!=!0){var offset=$scope.result.length;$http.get("/api/PlayList/Load?source="+$scope.tab+"&offset="+offset).then(function(datas){var data=datas.data;$scope.result=$scope.result.concat(data.result)})}};$scope.isActiveTab=function(tab){return $scope.tab===tab};$scope.loadPlaylist=function(){$http.get("/api/PlayList/Load?source="+$scope.tab).then(function(datas){var data=datas.data;$scope.result=data.result})}}]);app.controller("LoginController",["AuthenticationService","Notification","$rootScope","$cookies",function(AuthenticationService,Notification,$rootScope,$cookies){function login(){vm.dataLoading=!0;AuthenticationService.Login(vm.username,vm.password,function(response){response.success?(Notification.success("登陆成功"),showTag(1)):response.message&&Notification.error(response.message);vm.dataLoading=!1})}function register(){vm.dataLoading=!0;AuthenticationService.Register(vm.username,vm.password,function(response){response.success?(Notification.success("注册成功"),showTag(1)):response.message&&Notification.error(response.message);vm.dataLoading=!1})}function resetpassword(){if(hasReset){Notification.warning("邮件已发送，请查看您的电子邮件以重置密码");return}vm.dataLoading=!0;AuthenticationService.Reset(vm.username,function(response){response.success?(Notification.success("请查看您的电子邮件以重置密码"),hasReset=!0):response.message&&Notification.error(response.message);vm.dataLoading=!1})}function logout(){var user=$cookies.get("user");user!==null?AuthenticationService.Logout(function(response){response.success?Notification.success("注销成功"):response.message&&Notification.error(response.message)}):$rootScope.user.isLogin=!1}var vm=this,hasReset;vm.login=login;vm.register=register;vm.resetpassword=resetpassword;vm.logout=logout;hasReset=!1}])})();